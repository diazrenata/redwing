---
title: "5 sites"
output:
  github_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(drake)
library(dplyr)
library(ggplot2)
library(ghibli)

theme_set(theme_bw())
## Set up the cache and config
  db <- DBI::dbConnect(RSQLite::SQLite(), here::here("drake-cache.sqlite"))
  cache <- storr::storr_dbi("datatable", "keystable", db)
  cache$del(key = "lock", namespace = "session")
  
  loadd(all_overlaps, cache = cache)
loadd(all_smooths, cache = cache)  
loadd(all_svs, cache = cache)
loadd(all_composition, cache = cache)

DBI::dbDisconnect(db)
rm(cache)
rm(db)

```

## Overlaps

```{r}

all_overlaps <- left_join(all_overlaps, all_composition)

ggplot(filter(all_overlaps, !is.na(sim_seed)), aes(overlap)) + geom_histogram() + facet_wrap(vars(route), scales = "free_y", ncol = 3) + geom_histogram(data = filter(all_overlaps, is.na(sim_seed)), fill = "orange") + geom_histogram(data = filter(all_overlaps, is.na(sim_seed)), aes(x = composition_overlap), fill = "green")

```
So... given some amount of *species* turnover, there's going to be some constraint on how much the ISD can change. The ISD can't change a lot more than the species composition, but it can change a lot less. 

If it changes a lot less, that could be because similarly sized species are replacing each other. 

```{r}

rt15 <- filter(all_smooths, is.na(sim_seed), route == 15)

ggplot(rt15, aes(mass, start)) + geom_line() + geom_line(aes(y = end), linetype = 5)


ggplot(filter(all_smooths, route == 15, sim_seed == 60346513), aes(mass, start)) + geom_line() + geom_line(aes(y = end), linetype = 5)



```


```{r}


route_15_wide <- filter(all_svs, route == 15) %>%
  select(energy, mean_energy, timechunk, sim_seed) %>%
  tidyr::pivot_wider(id_cols = sim_seed, names_from = timechunk, values_from = c( "energy", "mean_energy"))


ggplot(route_15_wide, aes(abs(energy_start - energy_end), fill = is.na(sim_seed))) + 
  geom_histogram(data = filter(route_15_wide, !is.na(sim_seed)), bins = 100) +
  geom_histogram(data = filter(route_15_wide, is.na(sim_seed)), bins = 100)



route_3_wide <- filter(all_svs, route == 3) %>%
  select(energy, mean_energy, timechunk, sim_seed) %>%
  tidyr::pivot_wider(id_cols = sim_seed, names_from = timechunk, values_from = c( "energy", "mean_energy"))


ggplot(route_3_wide, aes(abs(energy_start - energy_end), fill = is.na(sim_seed))) + 
  geom_histogram(data = filter(route_3_wide, !is.na(sim_seed)), bins = 100) +
  geom_histogram(data = filter(route_3_wide, is.na(sim_seed)), bins = 100)
```
