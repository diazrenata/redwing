---
output:
   pdf_document: default
   word_document:
    reference_docx: default_gdoc.docx
csl: ecology.csl
bibliography: refs.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, include = F, results = F, message = F, warning = F, fig.dim = c(3.5, 2))
library(dplyr)
library(BBSsize)
library(rwar)
library(tidybayes)

library(ggplot2)
theme_set(theme_bw())
dat <- MATSS::get_bbs_route_region_data(route = 224, region = 3)
load(here::here("aspirational_structure", "pipelines", "portable_results_compare.Rds"))
load(here::here("aspirational_structure", "pipelines", "portalbe_comps_all.Rds"))
```


# Introduction/Framing

Understanding the interrelated dynamics of size- and -abundance based dimensions of biodiversity is key to understanding biodiversity change in the Anthropocene. Total abundance - i.e. the total number of individual organisms present in a system - and size-based currencies, such as the total biomass or total metabolic flux (“energy use”) of a system, are intertwined, but nonequivalent, measures of biological function. Abundance is more closely tied to species-level population dynamics, while size-based metrics more directly reflect assemblage-level resource use and contributions to materials fluxes at the broader ecosystem scale [@morlon2009; @dornelas2011; @white2007; @connolly2005]. While these currencies are naturally linked [@henderson2010; @morlon2009], changes in size composition can decouple the dynamics of one currency from another [@dornelas2011; @white2004; @white2007; @ernest2009; @yen2017]. This can mean that intuition from one currency may be misleading about others; a trend in numerical abundance might mask something else going on with biomass [@white2004]. Changes in size composition strong enough to decouple currencies may be symptomatic of important changes in ecosystem status- e.g. abundance-biomass comparison curves [@petchey2010]; size-biased extinctions [@young2016; @smith2018]. This underscores the need to understand how these dynamics are playing out in the Anthropocene [@fisher2010]. 


At the **community scale**, changes in the relationship between size and abundance tells us about important functional shifts. This is the scale at which ecological processes (i.e. compensatory dynamics, niche tracking, functional replacement) come into play - in contrast to population or global trends [@mcgill2015; @dornelas2014; @white2007]. To the extent that size is a proxy for other functional traits, changes or consistency in the community-level size structure (individiual size distribution, ISD) over time may reflect processes related to niche structure [@white2007; @petchey2010]. Strong size shifts can decouple the relationship between abundance and biomass. In aquatic systems, such changes in the scaling between abundance and biomass often signal ecosystem degradation [@petchey2010; @kerr01; @warwick1994 and refs therein]. Compensatory shifts in the size structure can buffer community function (in terms of biomass or energy use) against changes in abundance [@terry2015; @ernest2009; @white2004]. Consistency in the size structure may maintain the relationship between size- and -abundance based currencies, even as species composition, total abundance, and total biomass/total energy use fluctuate over time, which can reflect consistency in the niche structure over time [@holling1992]. 


It is important to improve our understanding of these dynamics for terrestrial animal communities in particular. In contrast to terrestrial trees and aquatic systems [@kerr01; @white2007], how the relationship between size and abundance changes over time, and the consequences of these changes for ecosystem-level properties, remain relatively unknown for terrestrial animals (but see @white2004). Terrestrial animal communities exhibit size structure [@ernest2005; @thibault2011], and case studies have demonstrated that size shifts can either decouple N from E for terrestrial animals [@white2004; @yen2017], but not always [@hernandez2011]. Establishing generalities in these dynamics is especially pertinent in the Anthropocene, as these communities are experiencing extensive and potentially size-structured change, with implications at community, ecosystem, and global scales [@young2016; @schmitz2018].

Macroecological-scale synthesis on the interrelated dynamics of the ISD, total abundance, and community function for terrestrial animals has been constrained by 1) a lack of community-level size and abundance timeseries data for these systems [@white2007; @thibault2011], and 2) appropriate statistical methods for relating change in the size structure to changes in abundance and function [@thibault2011; @yen2017]. In contrast to aquatic and forest systems, most long-term surveys of animal communities do not collect data on individuals' *sizes* across a full community (with the exception of small mammal studies, which have made major contributions to our understanding of the dynamics of size, abundance, and function for these systems; [@ernest2005; @white2004; @hernandez2011; @kelt2015]). Global, continental, or population-wide studies capture different phenomena [@white2007; this is a nod to a few studies looking at the size structure *across britain* or something]. The ISDs for terrestrial animals, and specifically for determinate growing taxa (e.g. mammals, birds), are often complex, multimodal distributions [@holling1992; @ernest2005; @thibault2011; @yen2017], and less statistically tractable than the power-law ISDs found in aquatic and tree systems [@kerr01; @white2007; more]. Quantifying change in the size structure, and relating this to change in community-wide abundance and function, is not as straightforward as computing and comparing slopes. As a result, we do not have a general understanding of either 1) the extent to which changes in the ISD decouple the community-level dynamics of abundance, biomass, and energy use in these systems, or of 2) the underlying changes in community structure that account for these effects. 

Here, we begin to address this gap by exploring how temporal changes in species composition and the size spectrum modulate the relationship between total abundance, energy, and biomass for communities of North American breeding birds. We used allometric scaling to estimate community size and abundance data for the North American Breeding Bird Survey, and evaluated how changes in total abundance, biomass, and energy use have co-varied from 1988-2018. Specifically, we examined: 1) How often do these currencies change together vs. have decoupled dynamics?; 2) What are the dominant directions and magnitudes of the overall change and any decoupling between the currencies? We also examined how these changes differ between core species and the whole-community (i.e. including transients), which currently comes completely out of left  field in this introduction (sorry!).

# Methods

## Bird abundance data


We used data from the Breeding Bird Survey [@sauer2013] to compare community attributes along each route between the 5-year periods from 1988-1992 and 2014-2018. We take the route to be the "community" scale [@thibault2011; others]. BBS (BBS methods background). We filtered the data to remove taxa that are poorly sampled through these methods, following (literally everyone). We accessed the data, and performed this preliminary cleaning and filtering, using the R package `MATSS` [@ye2020]. 


We used a discrete time-period comparison (as opposed to continuous-time over the full timeseries) to simplify comparisons between temporal turnover in the size structure - which are complex, multidimensional distributions - and changes in community-wide total abundance, biomass, and energy use. We acknowledge that a continuous-time perspective may be better equipped to detect nonlinear dynamics [@macgregor2019] and account for artefacts related to the selected beginning and ending dates [@cusser2020; @bahlai2021]. Developing continuous-time methods for analyzing community distributions such as the size spectrum is an important and ongoing area of methodological development (e.g. @yen2017). 

We used 5-year periods to account for sampling accumulation effects in characterizing the bird community in each time period [@white2004a]. We used the same begin and end dates for all routes in the analysis so as to have a consistent window. We explored the number of routes in the dataset with complete sampling coverage for two five-year “begin” and “end” periods with start dates ranging from 1970 to 1990 and end dates ranging from 2000 to 2018, and selected beginning and ending dates of 1988 and 2018 so as to obtain a large number of routes from diverse bird conservation regions, and span a relatively long window of time (could ref @cusser2020 there). This yielded 528 routes. 
å
            
##  Estimated size data

BBS contains abundances for all species along a route in each year, but does not include measurements of individual body size. We generated body size estimates for individual birds assuming that intraspecific size distributions are normally distributed around a species’ mean body size (following @thibault2011). Using records of species’ mean and standard deviation body sizes from @dunning2007, we drew individuals’ body sizes from the appropriate normal distributions. For species for which there was not a standard deviation recorded in @dunning2007 (185 species affected, of 421 total), we estimated the standard deviation based on an allometric scaling relationship between mean and standard deviation in body mass ($log(variance) = -5.273 + (log(mass) * 1.995))$; model R2 .86; see also @thibault2011). For species with multiple records in @dunning2007, we used the mean mean and standard deviation body sizes across all records (averaging across sexes, subspecies, and records from different locations). We performed this averaging after estimating any missing standard deviation measurements. For each individual bird observed, we estimated metabolic rate as $10.5 * (mass ^.713)$ [@fristoe2015; @nagy2005; @mcnab2009]. For each route in a given year, we compute total energy use, total biomass, and total abundance by summing over all individuals observed on that route in that year. This method does not incorporate intraspecific variation in body size across geographies or over time [@dunning2007; @gardner2011]. However, it makes it possible to conduct macroecological studies of avian size distributions at a spatial and temporal scale that would otherwise be impossible [@thibault2011].


## Comparing ISDs over time

For each route, we used two approaches to test whether the ISD for 1988-1992 is significantly different from the one for 2014-2018. First, we used a Kolmogorov-Smirnov test on the vector of masses for the beginning and end time periods. Second, we performed bootstrap resampling to test whether the observed degree of dissimilarity between the two time periods exceeded that which would be expected if the probability of an individual being a particular size did not depend on which time period it was observed in (I believe following @ernest2005). From the pool of all individuals observed in both timeperiods, we re-assigned individuals to each time period at random and without replacement, and computed the Kolmogorov-Smirnov test statistic $D$ comparing the resulting vectors of masses for each time period. We repeated this 500 times, and calculated the percentile score and standardized effect size (SES) of Kolmogorov-Smirnov $D$ for the *observed* ISDs compared to the distribution of $D$s from the bootstrap samples. Percentile scores > 95 and SES > 2 correspond to an observed pair of ISDs significantly more dissimilar than the bootstrap samples. 

For an intuitive measure of the *magnitude* of change in the ISD over time, we compute an overlap measure (see @read2018 for this measure applied to species-level body size distributions). We characterize the ISD as a smooth function by fitting a Gaussian mixture model (to logarithm of mass, up to 15 Gaussians, select best using BIC, all following @thibault2011). We evaluate the density function of the GMM at points for a size range from 0-exp(15), which covers the range of sizes in this dataset with ample padding on each side. We rescale the density function so the total area under the ISD is 1. We calculate the overlap between two ISDs as the sum of the minimum density at each evaluation point. This ranges from 0 (no overlap) to 1 (complete overlap) [@read2018]. 

```{r ks demo}

one_isd <- just_isd(dat, 1989) %>%
  filter(year %in% c(1988:1992, 2014:2018)) %>%
  mutate(timeperiod = ifelse(year > 2000, "end", "begin"))


isd_comparison <- be_comparison(dat, n_isd_draws = 1)


shuffled_isd <- one_isd %>%
  mutate(mass = sample(mass, size = nrow(one_isd), replace = F))


begin_actual_isd <- add_gmm(filter(one_isd, year %in% 1988:1992)) %>% mutate(timeperiod = "begin")
end_actual_isd <- add_gmm(filter(one_isd, year %in% 2014:2018)) %>% mutate(timeperiod = "end")

actual_isd <- bind_rows(begin_actual_isd, end_actual_isd)


begin_bootstrap_isd <- add_gmm(filter(shuffled_isd, year %in% 1988:1992)) %>% mutate(timeperiod = "begin")
end_bootstrap_isd <- add_gmm(filter(shuffled_isd, year %in% 2014:2018)) %>% mutate(timeperiod = "end")

bootstrap_isd <- bind_rows(begin_bootstrap_isd, end_bootstrap_isd)

```

```{r, results=T, include=T}

ggplot(actual_isd, aes(mass, density, color = timeperiod)) + geom_line(alpha = .5) + ggtitle("Actual") 

ggplot(bootstrap_isd, aes(mass, density, color = timeperiod)) + geom_line(alpha = .5) + ggtitle("Shuffled (one shuffle)")



```


For this site (`r dat$metadata$location$routename`, `r dat$metadata$location$regionname`), the KS test p value is `r round(isd_comparison$actual_p[1], 4)`. The observed test statistic has a percentile of `r round(isd_comparison$d_percentile[1],2)` and  SES of `r round(isd_comparison$d_ses[1], 2)` compared to 500 bootstraps. The observed ISDs have an overlap of `r round(isd_comparison$overlap, 2)`.

## Decoupling of dynamics in total abundance, biomass, and energy use over time

### Sims

To test whether change in biomass or energy use deviates from the change in abundance, we can't just compare the slopes for total energy, total biomass, and total abundance to each other. This is because the three different currencies are on radically different scales of measurement. We also can't rescale using the usual methods (e.g. scale to mean 0/sd 1, sqrt transform @dornelas2014; @gotelli2017) because these destroy information about the range of variability within a single currency. Instead, we test whether the observed change in biomass or energy use differs from the change that we would expect given observed changes in community-wide abundance, but with *no change* in the ISD from beginning to end. 

Figures and functions walking through this procedure are at https://github.com/diazrenata/redwing/blob/resim-cleanup/aspirational_structure/methods_vignettes/change_over_time/02_01_change_over_time_sims.md but they're a little rough. 


We simulate change in total energy and total biomass under "no change in ISD" and "observed change in ISD" scenarios. We use the GMM smooth procedure described above to characterize a "sampling GMM" for each time period. The "sampling GMM" is a probability density function with the probability of observing an individual of a given mass across the spectrum of possible masses. Sampling `$mass` with probability `$density` is a random number generator for sizes. We then *re draw* individuals for each year under different scenarios. First, we draw individuals for each year using the actual ISD for that time period (so the "begin" ISD for 1988-1992 and the "end" ISD for 2014-2018). Second, we draw individuals for each year, but using the "begin" ISD for all years, to estimate community properties if the ISD had not changed from beginning to end. We compute the total energy use and total biomass for each year under each scenario. 

Note that we pool individuals within a time period to create the ISD, to smooth out species accumulation, but we draw individuals and compute total energy and biomass year-by-year, instead of pooling individuals over the whole time period, to capture interannual, intratimeperiod variation in total abundance (which propagates to total energy use and total biomass). 

```{r}

ssims <- ssims_wrapper(dat, "actual", 1989, 1, 1, 1989)

```

```{r, results=T, include=T, fig.dim = c(3.5, 3.5)}

ggplot(ssims, aes(year, total_biomass, color = source)) + geom_point() + geom_smooth(method = "lm", se = F) + ggtitle("Biomass") + theme(legend.position = "bottom")

ggplot(ssims, aes(year, total_energy, color = source)) + geom_point() + geom_smooth(method = "lm", se = F) + ggtitle("Energy use") + theme(legend.position = "bottom")

```

Here, the "abundance" line (red) reflects change in total biomass expected due only to changes in abundance. The "currency" line reflects change in total biomass due to change in abundance *and* observed change in the size structure. Deviations in slope between the red and blue lines reflect change driven by the ISD. Note that the lines here are crude linear model smooths and not really suitable for inference, just visualization. 

### Testing change

We use Bayesian linear models to test whether change in the ISD decouples the dynamics of total biomass/total energy use from that which would be expected due to change in abundance. 

Figures and functions here:  https://github.com/diazrenata/redwing/blob/resim-cleanup/aspirational_structure/methods_vignettes/change_over_time/02_02_testing_change.md (but rough). I have also run this whole pipeline on a few toy sim scenarios to confirm that it behaves as expected. I can write that up for the supplement/include it here if it seems important. 

We evaluate change at the route level, because we care most about the decoupling of slopes for "currency" and "abundance" at the route level. I tried fitting everything within one hierarchical model, but the hierarchical model attributes a lot of variation to getting the right intercept for each route (which we don't care about) and does a really bad job estimating within-route slopes and decoupling (which is what we do care about). It's also very intensive to compute for a large number of routes and I never managed to run it on the full dataset. These are challenges you don't run into if - like @dornelas2014 - you're only interested in change in one currency per site.

For each currency for each route, we fit 3 models:

1. `total_biomass ~ timeperiod * scenario`: I call this one "full"; this model has a slope for abundance, and an offset resulting in a *different* slope for currency
1. `total_biomass ~ timeperiod`: I call this one "nosource"; this one has a slope for abundance but not a different slope for currency
1. `total_biomass ~ 1`: Intercept-only model, no change over time. 
1. Note I do not include a `total_biomass ~ timeperiod + scenario` model. That model would fit a separate intercept but not separate slope for "currency". Because of the sim structure, "abundance" and "currency" start with the same values (give or take sampling error) and therefore should have the same intercept. Including this model is nonsensical and sometimes messes up model selection, for example if it finds it can get away with fitting an intercept instead of the "full" model above. We want to force it to use a slope in that situation.
    
We fit as Gaussians with default priors, run for 8000 iterations. We fit as Gaussians to avoid having to deal with back-transforming the parameter estimates (and because when I coerced to other family distributions I got tons of convergence issues). We checked for convergence issues (high Rhat, low effective sample size, or divergent transitions), but running for 8000 iterations is extremely generous for these models and there were none. We used LOO-crossvalidation (as implemented in `rstanarm::loo`) to select the best-fitting model as the simplest model with an ELPD within 1 SE of the best-fitting model, using `reloo` to correct for outliers. 

If the best-fitting model does not include the scenario term (i.e. "currency" separate from "abundance"), it means that the change in the ISD does not ~significantly decouple the dynamics of total energy/biomass from that which is driven by changes in abundance. If there is no **timeperiod** term, it means that there's not a ~significant change begin-end.

We fit these models for `total_biomass` and `total_energy` for all routes. For each currency, we tallied:  1. How often the best model includes the "source" term (meaning there's a decoupling); 2. how often there's a timeperiod but no source term (meaning there's change over time, but that biomass/energy use do not diverge from abundance); 3. how often there's no timeperiod term (meaning no ~significant change begin to end). 



For the example site we've been working with, here are the winning models. For the "actual" sims, both biomass and energy select the "full" model, meaning there's a decoupling between the size-based currencies and just abundance. This table includes two quality control sims. First, "nochange" sims - in which the abundances for the begin and end are held the same, and which correctly selects a "no change over time" model - and second, "nosizechange" sims - in which the ISD is held the same, and which correctly selects change over time, but no decoupling. 

```{r, results = T, include = T}

filter(all_winners, matssname == "bbs_rtrg_224_3") %>%
  select(simtype, currency, model)

```


For models with slope  and/or offset terms, we extracted estimates for the slope for abundance, and the offset for currency, to examine the magnitude and direction of change and decoupling. We tallied how often the abundance slope was positive or negative (how often the 95% CI for the timeperiod term is >/< 0) and how often the offset for currency is positive or negative (how often the 95% CI for the timeperiod:source term is >/< 0). Positive offsets mean that the change in biomass/energy use is less negative than change in abundance; negative offsets mean that the currency is more negative. 

For the "actual" sims, here are the parameter estimates for the slope and offset. Thick bars are the 95% and thin bars are the 99% CIs. For both energy and biomass, the abundance-driven trajectory is an increase, but it's less of a strong increase for biomass. For both, the currency-driven offset is also an increase, meaning that the change in the ISD caused biomass to increase more than we expect it to just because of the increase in abundance. 


```{r, results = T, include = T}

these_qis <- filter(all_qis, simtype == "actual", matssname == "bbs_rtrg_224_3")

ggplot(these_qis, aes(timeperiodend, currency)) + geom_pointinterval(aes(xmin = timeperiodend.lower, xmax = timeperiodend.upper)) + ggtitle("Slope term") + geom_vline(xintercept = 0)


ggplot(these_qis, aes(`timeperiodend:sourcecurrency`, currency)) + geom_pointinterval(aes(xmin = `timeperiodend:sourcecurrency.lower`, xmax = `timeperiodend:sourcecurrency.upper`)) + ggtitle("Offset due to currency term") + geom_vline(xintercept = 0)


```

## Miscellany

*These probably belong in figure captions/supplements, not as the methods.*

### Relating change in the ISD to decoupling 

The ISD may change without resulting in a detectable decoupling of the dynamics of biomass/energy use and abundance at the whole-system level, if the change in the ISD is relatively ~balanced above and below the mean body size. We tested whether communities with a decoupling showed greater change in the ISD than systems that did not, using a linear model of the form `isd_overlap ~ winning_model_type`. We also tested the extent to which change in mean body size was linked to change in the ISD using a quadratic model of the form `isd_overlap ~ logratio_mean_body_size + logratio_mean_body_size ^ 2`. We fit a quadratic model because we expected there to be a unimodal relationship, because high ISD overlap constrains there to be very little change in mean body size. 


### Core-transient

Because core and transient species may have different dynamics, we ran this pipeline on whole communities, and using just core species (those present in >= 2/3 of timesteps).

### Highly-sampled BCRs

Sometimes I subsample the 528 to get a maximum of 10 routes per bird conservation region, so that the highly-sampled BCRs don't  dominate aggregate analyses [@thibault2011]. That yields 238 routes total. Results are the same.

#### Null models note

I have an instinct that reviewers may ask about null models to distinguish "systematic" change in the ISD from random change in the ISD. There are real constraints on how deeply we can investigate that due to the structure of the data and the computation required for this pipeline. Because BBS doesn't have population parameters, we have to take populations sizes as face value as constraints for a null model - but some of the ISD change is baked into the population sizes. Null models in this space also have a high type II error rate; it can be very hard to deviate from them, especially if they're highly constrained. In my tests with contrived data/Portal, I have to have an almost pure change scenario to get a deviation - either *all* of the change in species' abundances has to be directional on the size axis, or *all* of the change has to be a like-for-like size replacement. And, this pipeline is computationally intensive to a degree that prohibits repeated runs (to the tune of 100-500 null repetitions). So, I am not leaning strongly on incorporating null models as a way of distinguishing "systematic" vs "non-size-structured" dynamics here.  

That said - I have run null models *once* for intuition and may be able to coax it up to 10ish runs. From these runs and my past null models in this space, I don't see evidence of strong deviations from null models. I don't take this as compelling evidence that there is or isn't size structured change happening, but as an indication that we can't distinguish that at this scale. 

# Results

## Change in the ISD begin-to-end








<!-- Discussion points -->
<!-- Overall, a signal of ~parallel dynamics, and particularly decreases, in abundance, biomass, and energy use over time -->
<!-- About 50% of the time, not significant. But when significant, overwhelmingly 1) a decrease and 2) changing together. -->
<!-- This is consistent with concerns about declines in abundance, but not consistent with size-structured declines amplifying declines in function beyond abundance  (Dirzo et al. 2014). -->
<!-- Note that this study is not definitive for biodiversity monitoring -->
<!-- Discrete vs. continuous time -->
<!-- Geographic bias in routes -->
<!-- Continuous-time methods for ISD work, and case studies better targeted for biodiversity monitoring, are both next-steps -->
<!-- Relationship usually maintained due to low taxonomic turnover, but not detectably through functional replacement -->
<!-- Low taxonomic turnover may reflect stable niche structure over time. -->
<!-- Absent the empirical basis for parameterizing a null model of species turnover (e.g. the necessary parameters to run neutral simulations), we cannot distinguish between random and systematic dynamics of taxonomic change.  -->
<!-- But, we observe pretty low turnover. -->
<!-- There is no dominating signal of functional replacement conserving the size structure beyond what is expected given taxonomic turnover + the species pool. -->
<!-- This null model is inherently conservative, with a high type-II error rate (Ulrich et al. 2017). Not deviating does not necessarily mean there’s no size structured dynamics. There may be both size structured replacement and size shifts operating simultaneously, or simply weak/imperfect functional replacement.  -->
<!-- Or, birds might be less strongly size-structured than fish, trees, or rodents. There are more ways to be a 20g bird than a 20g pocket mouse. -->
<!-- When there is a decoupling of currencies, tends to be an increase in body size → less negative slope in biomass/energy vs abundance -->
<!-- Contrasts with concerns about size-biased extinctions -->
<!-- Consistent with other reports from BBS (Schipper et al. 2016) -->
<!-- May reflect forests in ~recovery over this time period (Schipper et al. 2016) -->
<!-- Get into some case studies here -->
<!-- These results might or might not be borne out in other taxonomic groups or other geographic regions. -->
<!-- BBS is on intact habitats in systems that may have been recovering - counter to global trends or trends in areas of particular concern -->
<!-- Next steps should include specifically exploring systems that have undergone major disturbances, and/or a large degree of taxonomic turnover.  -->
<!-- And greater taxonomic coverage - comparative work between mammals and birds, for example -->

\newpage
# References
